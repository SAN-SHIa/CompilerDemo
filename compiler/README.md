# C语言编译器实现

基于Flex&Bison工具链的完整C语言编译器实现，支持从源代码到目标代码的完整编译流程。

## 🛠️ 环境要求

- **MSYS2/MinGW-w64** - Windows下的类Unix环境
- **Flex** - 词法分析器生成工具
- **Bison** - 语法分析器生成工具
- **GraphViz** - 图形可视化工具
- **GCC** - GNU编译器集合

确保所有工具都已添加到系统PATH环境变量中。

## 🚀 编译与运行

### 编译编译器
```bash
# 使用Makefile编译
mingw32-make -f Makefile.win
```

### 运行编译器
```bash
# 编译C源文件
.\compiler.exe test.c

# 编译器将生成以下文件：
# - ast.dot        抽象语法树DOT文件
# - ast.png        抽象语法树图像
# - output.s       伪汇编代码
# - output.c       生成的C代码
# - output_x64.s   x86-64汇编代码
# - output.exe     可执行文件
```

## 📁 文件结构

```
compiler/
├── README.md              # 本说明文档
├── 说明.md               # 详细技术说明
├── Makefile.win          # Windows构建脚本
├── test.c                # 测试用例 
│
├── 词法分析 (Lexical Analysis)
│   ├── lexer.l           # Flex词法分析器定义
│   └── lex.yy.c          # 生成的词法分析器代码
│
├── 语法分析 (Syntax Analysis)  
│   ├── parser.y          # Bison语法分析器定义
│   ├── parser.tab.c      # 生成的语法分析器代码
│   └── parser.tab.h      # 语法分析器头文件
│
├── 抽象语法树 (Abstract Syntax Tree)
│   ├── ast.h             # AST结构定义
│   ├── ast.c             # AST实现
│   ├── ast.dot           # 生成的DOT文件
│   └── ast.png           # 生成的语法树图像
│
├── 语义分析 (Semantic Analysis)
│   ├── semantic.h        # 语义分析接口定义
│   ├── semantic.c        # 语义分析实现
│   ├── symbol_table.h    # 符号表结构定义
│   └── symbol_table.c    # 符号表实现
│
├── 中间代码生成 (Intermediate Code)
│   ├── ir.h              # 中间代码表示定义
│   └── ir.c              # 中间代码生成实现
│
├── 代码优化 (Code Optimization)
│   ├── optimize.h        # 代码优化器接口
│   └── optimize.c        # 代码优化器实现
│
├── 目标代码生成 (Code Generation)
│   ├── codegen.h         # 目标代码生成接口
│   └── codegen.c         # 目标代码生成实现
│
├── 解释器 (Interpreter)
│   ├── interpreter.h     # 解释器接口定义
│   └── interpreter.c     # 解释器实现
│
├── 输出文件 (Generated Files)
│   ├── output.c          # 生成的C代码
│   ├── output.s          # 伪汇编代码
│   ├── output_x64.s      # x86-64汇编代码
│   ├── output.exe        # 可执行文件
│   ├── output_fixed.c    # 修复后的C代码
│   └── compiler.exe      # 编译器可执行文件
│
└── 语义分析测试 (Semantic Testing)
    └── semantic_test/    # 语义分析专项测试
        ├── README_SEMANTIC.md
        ├── ast.c
        ├── semantic.c
        ├── semantic.h
        ├── symbol_table.c
        ├── symbol_table.h
        ├── semantic_test.c
        └── semantic_test_en.c
```

## 🔧 编译器功能

### 1. 词法分析 (Lexer)
- **关键字识别**：`int`、`float`、`return`、`if`、`else`、`while`
- **标识符和常量**：变量名、整数、浮点数
- **运算符**：`=`、`+`、`-`、`*`、`/`、`==`、`!=`、`<`、`>`、`<=`、`>=`
- **分隔符**：括号、大括号、分号等
- **错误处理**：非法字符检测和报告

### 2. 语法分析 (Parser)
- **函数定义**：支持基本函数结构
- **变量声明**：支持类型声明和初始化
- **控制结构**：
  - 条件语句（if-else）
  - 循环语句（while）
  - 复合语句（代码块）
- **表达式**：算术运算、比较运算
- **语法错误恢复**：解决经典的dangling-else问题

### 3. 抽象语法树 (AST)
- **完整节点类型**：涵盖所有语法结构
- **树构建**：从语法分析自动构建AST
- **可视化**：生成DOT格式并转换为PNG图像
- **内存管理**：自动内存分配和释放

### 4. 符号表管理
- **多级作用域**：支持嵌套作用域
- **符号类型**：变量和函数符号
- **数据类型**：int和float基本类型
- **查找机制**：支持作用域链查找
- **可视化输出**：格式化符号表打印

### 5. 语义分析
- **类型检查**：严格的类型系统
- **变量检查**：
  - 未声明变量使用检测
  - 变量重复声明检测
- **类型转换**：
  - 隐式类型转换（int ↔ float）
  - 转换警告机制
- **函数检查**：返回类型一致性检查
- **错误报告**：详细的错误定位和描述

### 6. 中间代码生成
- **三地址码**：标准的中间表示形式
- **支持操作**：
  - 基本算术和逻辑运算
  - 变量加载和存储
  - 条件跳转和无条件跳转
  - 函数调用框架
- **类型处理**：自动类型转换插入
- **临时变量**：自动临时变量管理

### 7. 代码优化
- **常量优化**：
  - 常量折叠
  - 常量传播
- **代数简化**：`x+0=x`、`x*1=x`等
- **代码清理**：
  - 死代码消除
  - 复制传播
- **表达式优化**：公共子表达式消除
- **多遍优化**：可配置优化级别

### 8. 目标代码生成
- **多目标支持**：
  - 伪汇编代码（教学用）
  - x86-64汇编代码
  - C代码生成
- **寄存器分配**：基础寄存器管理
- **指令优化**：指令选择和调度
- **函数处理**：序言和尾声代码生成

## 📋 支持的C语言特性

### 数据类型
- `int` - 32位整数
- `float` - 32位浮点数

### 变量操作
- 变量声明：`int x;`、`float y;`
- 变量初始化：`int x = 10;`
- 变量赋值：`x = y + 5;`

### 表达式
- **算术运算**：`+`、`-`、`*`、`/`
- **比较运算**：`==`、`!=`、`<`、`>`、`<=`、`>=`
- **优先级**：正确的运算符优先级和结合性

### 控制结构
- **条件语句**：
  ```c
  if (condition) {
      // statements
  } else {
      // statements
  }
  ```
- **循环语句**：
  ```c
  while (condition) {
      // statements
  }
  ```

### 函数
- **函数定义**：基本函数结构支持
- **返回语句**：`return expression;`

## 🧪 测试用例

### test.c - 综合测试
演示编译器的主要功能，包括：
- 变量声明和初始化
- 算术运算和类型转换
- 条件分支和循环
- 函数定义和返回

### 语义分析测试
位于`semantic_test/`目录，专门测试：
- 类型检查功能
- 作用域管理
- 错误检测机制

## 📊 输出示例

### 中间代码输出
```
func_begin main
x = 10
y = 5.50
t1 = x
t2 = y
t3 = t1 * t2
result = t3
t4 = result
t5 = (float) t4
t6 = t5 > 40.00
if !t6 goto L1
t7 = result
return t7
goto L2
L1:
    // 优化后的代码
L2:
func_end
```

### 优化统计
编译器会输出详细的优化统计信息，包括：
- 常量折叠次数
- 死代码消除数量
- 优化前后指令对比

## 🐛 错误处理

编译器提供详细的错误报告：
- **词法错误**：非法字符、未识别token
- **语法错误**：语法结构不正确
- **语义错误**：类型不匹配、未声明变量等
- **警告信息**：潜在问题提示

## 📚 技术文档

- `说明.md` - 详细的技术实现说明
- `semantic_test/README_SEMANTIC.md` - 语义分析专项说明
- `C_CODEGEN_FIX_SUMMARY.md` - 代码生成修复总结
- `INTERPRETER_README.md` - 解释器使用说明

## 🔄 编译流程

1. **词法分析** → Token流
2. **语法分析** → 抽象语法树
3. **语义分析** → 类型检查和错误检测
4. **中间代码生成** → 三地址码
5. **代码优化** → 优化后的中间代码
6. **目标代码生成** → 汇编/C代码
7. **可视化输出** → AST图像和分析报告

## 📝 使用注意事项

1. **编码格式**：源文件使用GB2312编码
2. **路径设置**：确保所有工具在PATH中
3. **依赖检查**：编译前检查所有依赖工具
4. **输出清理**：每次编译会覆盖之前的输出文件

## 🎓 学习价值

本编译器实现适合编译原理课程学习，涵盖：
- **理论到实践**：完整的编译器构造过程
- **工具使用**：主流编译器构造工具的应用
- **算法实现**：经典编译算法的具体实现
- **优化技术**：实用的代码优化方法
- **调试技巧**：编译器调试和测试方法

通过这个项目，可以深入理解编译器的工作原理和实现细节。
